"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[2619],{8901:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>l,contentTitle:()=>i,default:()=>h,frontMatter:()=>s,metadata:()=>o,toc:()=>c});var r=a(5893),t=a(1151);const s={sidebar_position:6},i="Custom Data Source",o={id:"connectors/customdata",title:"Custom Data Source",description:"It is possible to fetch data from a custom source such as an API, other database, file system, etc.",source:"@site/docs/connectors/customdata.md",sourceDirName:"connectors",slug:"/connectors/customdata",permalink:"/flowtide/docs/connectors/customdata",draft:!1,unlisted:!1,editUrl:"https://github.com/koralium/flowtide/tree/main/docs/docs/connectors/customdata.md",tags:[],version:"current",sidebarPosition:6,frontMatter:{sidebar_position:6},sidebar:"tutorialSidebar",previous:{title:"Kafka Connector",permalink:"/flowtide/docs/connectors/kafka"},next:{title:"Sharepoint Connector",permalink:"/flowtide/docs/connectors/sharepoint"}},l={},c=[{value:"Generic Data Source",id:"generic-data-source",level:2},{value:"Implementation example",id:"implementation-example",level:3},{value:"Trigger data reloads programatically",id:"trigger-data-reloads-programatically",level:3},{value:"SQL Table Provider",id:"sql-table-provider",level:3},{value:"Generic data sink",id:"generic-data-sink",level:2},{value:"Implementation example",id:"implementation-example-1",level:3}];function d(e){const n={code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h1,{id:"custom-data-source",children:"Custom Data Source"}),"\n",(0,r.jsx)(n.p,{children:"It is possible to fetch data from a custom source such as an API, other database, file system, etc."}),"\n",(0,r.jsx)(n.p,{children:"There are multiple ways:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Implement GenericDataSource(Async)"})," - Simplified source which should return C# objects. This is the recomended way to start implementing a source."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Implement ReadBaseOperator"})," - This allows the creation of a low-level read operator, where serialization, state storage, watermarks and checkpointing must be handled."]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"generic-data-source",children:"Generic Data Source"}),"\n",(0,r.jsx)(n.p,{children:"The generic data source allows easy implementation against custom sources that returns C# objects."}),"\n",(0,r.jsx)(n.p,{children:"It allows:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Full batch reloads, where all the data is imported again and delta is computed."}),"\n",(0,r.jsx)(n.li,{children:"Delta loads, where delta should be returned."}),"\n",(0,r.jsx)(n.li,{children:"Custom watermark provided by the source."}),"\n",(0,r.jsx)(n.li,{children:"Scheduling of full batch and delta reloads."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"There are two classes that can be implemented for the generic data source:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"GenericDataSourceAsync"})," - Data is returned by an IAsyncEnumerable, this should be used with remote sources."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"GenericDataSource"})," - Data is returned by an IEnumerable, which should be used in cases where data is already in memory."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"When implementing a generic data source, it is important to think about memory usage, for instance, do not\nfetch all rows and store them in memory and then return them, this can cause huge memory spikes or out of memory.\nInstead yield return values and fetch the data in batches. The operator stores the data in B+ trees that will be\ntemporarily stored on disk if the memory usage is too high."}),"\n",(0,r.jsx)(n.h3,{id:"implementation-example",children:"Implementation example"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:"public class ExampleDataSource : GenericDataSourceAsync<User>\n{\n    private readonly IUserRepository _userRepository;\n\n    public ExampleDataSource(IUserRepository userRepository) \n    {\n        _userRepository = userRepository;\n    }\n\n    // Fetch delta every 1 second\n    public override TimeSpan? DeltaLoadInterval => TimeSpan.FromSeconds(1);\n\n    // Reload all data every 1 hours, this is not required, but can be useful.\n    // If for instance deletes cant be found in deltas from the source,\n    // a full reload would find all deleted rows.\n    public override TimeSpan? FullLoadInterval => TimeSpan.FromHours(1);\n\n    protected override IEnumerable<FlowtideGenericObject<User>> DeltaLoadAsync(long lastWatermark)\n    {\n        var changes = _userRepository.GetChangesFromWatermarkAsync(lastWatermark);\n\n        await foreach(var change in changes) {\n            yield return new FlowtideGenericObject<User>(change.Id, change, change.Timestamp);\n        }\n    }\n\n    protected override IEnumerable<FlowtideGenericObject<User>> FullLoadAsync()\n    {\n        var data = _userRepository.GetAllDataAsync(lastWatermark);\n        \n        await foreach(var row in data) {\n            yield return new FlowtideGenericObject<User>(row.Id, row, row.Timestamp);\n        }\n    }\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["To use your data source, add the following to the ",(0,r.jsx)(n.em,{children:"ConnectorManager"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'connectorManager.AddCustomSource(\n    "{the table name}", \n    (readRelation) => new ExampleDataSource(userRepository));\n'})}),"\n",(0,r.jsx)(n.h3,{id:"trigger-data-reloads-programatically",children:"Trigger data reloads programatically"}),"\n",(0,r.jsx)(n.p,{children:"The generic data source also registers triggers that allows the user to notify the stream when a reload should happen."}),"\n",(0,r.jsx)(n.p,{children:"The following triggers are registered:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"full_load"})," - Does a full load on all running generic data sources"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"delta_load"})," - Does a delta load on all running generic data sources"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"full_load_{tableName}"})," - Full load for a specific source"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"delta_load_{tableName}"})," - Delta load for a specific source"]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Example on calling a trigger:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'await stream.CallTrigger("delta_load", default);\n'})}),"\n",(0,r.jsx)(n.p,{children:"Calling the triggers programatically can be useful if having an interval would cause too much latency for the data."}),"\n",(0,r.jsx)(n.h3,{id:"sql-table-provider",children:"SQL Table Provider"}),"\n",(0,r.jsx)(n.p,{children:"There is a table provider as well for the generic data source, that can be used to easily import table metadata from a class."}),"\n",(0,r.jsx)(n.p,{children:"Example:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'sqlPlanBuilder.AddGenericDataTable<User>("users");\n'})}),"\n",(0,r.jsx)(n.p,{children:"If you are starting Flowtide with dependency injection, a table provider is added automatically, so this step is not required."}),"\n",(0,r.jsx)(n.h2,{id:"generic-data-sink",children:"Generic data sink"}),"\n",(0,r.jsx)(n.p,{children:"The generic data sink allow the implementation of a sink that reads the rows as C# classes.\nThis limits the stream to only send those specific columns, but it can be useful im cases such as API integrations where there is a strict schema."}),"\n",(0,r.jsx)(n.h3,{id:"implementation-example-1",children:"Implementation example"}),"\n",(0,r.jsxs)(n.p,{children:["Create a class that inherits from ",(0,r.jsx)(n.em,{children:"GenericDataSink"}),"."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'internal class TestDataSink : GenericDataSink<User>\n{\n    public override Task<List<string>> GetPrimaryKeyNames()\n    {\n        return Task.FromResult(new List<string> { "{primaryKeyColumnName}" });\n    }\n\n    public override async Task OnChanges(IAsyncEnumerable<FlowtideGenericWriteObject<User>> changes)\n    {\n        await foreach(var userChange in changes)\n        {\n            if (!userChange.IsDeleted)\n            {\n                // Do upsert to destination\n            }\n            else\n            {\n                // Do delete against destination\n            }\n        }\n    }\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Add the generic data sink to the ",(0,r.jsx)(n.em,{children:"ConnectorManager"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-csharp",children:'connectorManager.AddCustomSink("{tableName}", (rel) => new testDataSink());\n'})})]})}function h(e={}){const{wrapper:n}={...(0,t.a)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},1151:(e,n,a)=>{a.d(n,{Z:()=>o,a:()=>i});var r=a(7294);const t={},s=r.createContext(t);function i(e){const n=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),r.createElement(s.Provider,{value:n},e.children)}}}]);